{% extends "base.html" %}
{% load static %}
{% load my_filters_and_tags %}

{% block title %}
    é¦–é¡µ
{% endblock title %}

{% block content %}

    <div class="container">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <!-- æœ€æ–°/æœ€çƒ­å¯¼èˆª -->
                <li class="breadcrumb-item">
                    <a href="{% url 'article:article_list' %}?search=&column={{ column }}&tag={{ tag }}">
                        æœ€æ–°
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'article:article_list' %}?order=total_views&search=&column={{ column }}&tag={{ tag }}">
                        æœ€çƒ­
                    </a>
                </li>

                <!-- AI åŠ©æ‰‹ åœ¨ ä¸ªäººåšå®¢çš„å·¦è¾¹ -->
                <li class="breadcrumb-item">
                    <a href="{% url 'article:ai_chat' %}" class="text-success">
                        <i class="fas fa-robot"></i> AI åŠ©æ‰‹
                    </a>
                </li>

                <!-- æ–°å¢ä¸ªäººåšå®¢å…¥å£ -->
                <li class="breadcrumb-item ml-auto">
                    {% if user.is_authenticated %}
                        <a href="{% url 'article:my_articles' %}" class="text-primary">
                            <i class="fas fa-user-edit"></i> ä¸ªäººåšå®¢
                        </a>
                    {% else %}
                        <a href="{% url 'userprofile:login' %}?next={% url 'article:my_articles' %}"
                           class="text-muted"
                           title="è¯·å…ˆç™»å½•"
                           data-toggle="tooltip">
                            <i class="fas fa-user-lock"></i> ä¸ªäººåšå®¢
                        </a>
                    {% endif %}
                </li>
            </ol>
        </nav>


        <!-- æœç´¢æ  -->
        <div class="row">
            <div class="col-auto mr-auto">
                <form class="form-inline" method="get" action="{% url 'article:article_list' %}">
                    <label class="sr-only">content</label>
                    <input type="text"
                           class="form-control mb-2 mr-sm-2"
                           name="search"
                           placeholder="æœç´¢æ–‡ç« ..."
                           value="{% if search %}{{ search }}{% endif %}"
                           required
                           list="search-history">

                    <!-- å†å²æœç´¢è®°å½• -->
                    <datalist id="search-history">
                        {% for keyword in search_history %}
                            <option value="{{ keyword.decode }}">{{ keyword.decode }}</option>
                        {% endfor %}
                    </datalist>

                    <button type="submit" class="btn btn-primary mb-2">æœç´¢</button>
                </form>
            </div>
        </div>

        <!-- é¡µé¢æ ‡é¢˜ -->
        <h4 class="my-4">
            {% if is_my_articles %}
                <i class="fas fa-file-alt"></i> æˆ‘çš„æ–‡ç« åˆ—è¡¨
            {% elif search %}
                <span style="color: red">"{{ search }}"</span>çš„æœç´¢ç»“æœ
            {% else %}
                <i class="fas fa-list-ul"></i> æ‰€æœ‰æ–‡ç« åˆ—è¡¨
            {% endif %}
        </h4>

        <!-- åˆ—è¡¨å¾ªç¯ -->
        <div class="row mt-2">
            {% for article in articles %}
                <div class="col-12 position-relative mb-4">
                    <!-- ç¼–è¾‘æŒ‰é’® -->
                    {% if user == article.author or is_my_articles %}
                        <div class="position-absolute" style="right: 15px; top: 15px; z-index: 1;">
                            <a href="{% url 'article:article_update' article.id %}"
                               class="btn btn-sm btn-outline-primary"
                               data-toggle="tooltip"
                               title="ç¼–è¾‘æ–‡ç« ">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    {% endif %}

                    <!-- æ–‡ç« å†…å®¹ -->
                    <div class="card shadow-sm">
                        <div class="row no-gutters">
                            {% if article.avatar %}
                                <div class="col-md-3">
                                    <img src="{{ article.avatar.url }}"
                                         class="card-img"
                                         alt="avatar"
                                         style="height: 200px; object-fit: cover;">
                                </div>
                            {% endif %}

                            <div class="col-md-{% if article.avatar %}9{% else %}12{% endif %}">
                                <div class="card-body">
                                    <!-- æ ç›®å’Œæ ‡ç­¾ -->
                                    <div class="mb-2">
                                        {% if article.column %}
                                            <a href="{% url 'article:article_list' %}?column={{ article.column.id }}"
                                               class="badge
                                           {% if article.column.title == 'Django' %}badge-success
                                           {% elif article.column.title == 'Java' %}badge-danger
                                           {% elif article.column.title == 'HTML' %}badge-warning
                                           {% else %}badge-primary{% endif %}">
                                                {{ article.column }}
                                            </a>
                                        {% endif %}

                                        {% for tag in article.tags.all %}
                                            <a href="{% url 'article:article_list' %}?tag={{ tag }}"
                                               class="badge badge-secondary">
                                                {{ tag }}
                                            </a>
                                        {% endfor %}
                                    </div>

                                    <!-- æ ‡é¢˜ -->
                                    <h4 class="card-title">
                                        <a href="{% url 'article:article_detail' article.id %}"
                                           class="text-dark font-weight-bold">
                                            {{ article.title }}
                                        </a>
                                    </h4>

                                    <!-- æ‘˜è¦ -->
                                    <p class="card-text text-muted">
                                        {{ article.body|striptags|truncatechars:150 }}
                                    </p>

                                    <!-- å…ƒä¿¡æ¯ -->
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted small">
                                        <span class="mr-3">
                                            <i class="fas fa-eye text-info"></i>
                                            {{ article.total_views }}
                                        </span>
                                            <span class="mr-3">
                                            <i class="fas fa-comments text-success"></i>
                                            {{ article.comments.count }}
                                        </span>
                                            <span>
                                            <i class="fas fa-clock text-pink"></i>
                                            {{ article.created|timesince_zh }}
                                        </span>
                                        </div>
                                        <small class="text-muted">
                                            ä½œè€…ï¼š{{ article.author.username }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- é¡µç å¯¼èˆª -->
        <div class="pagination row mt-4">
            <div class="m-auto">
            <span class="step-links">
                {% if articles.has_previous %}
                    <a href="?page=1&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                       class="btn btn-sm btn-success">
                        &laquo; 1
                    </a>
                    <span class="mx-2">...</span>
                    <a href="?page={{ articles.previous_page_number }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                       class="btn btn-sm btn-secondary">
                        {{ articles.previous_page_number }}
                    </a>
                {% endif %}

                <span class="current btn btn-sm btn-danger mx-2">
                    {{ articles.number }}
                </span>

                {% if articles.has_next %}
                    <a href="?page={{ articles.next_page_number }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                       class="btn btn-sm btn-secondary">
                        {{ articles.next_page_number }}
                    </a>
                    <span class="mx-2">...</span>
                    <a href="?page={{ articles.paginator.num_pages }}&order={{ order }}&search={{ search }}&column={{ column }}&tag={{ tag }}"
                       class="btn btn-sm btn-success">
                        {{ articles.paginator.num_pages }} &raquo;
                    </a>
                {% endif %}
            </span>
            </div>
        </div>
    </div>
    {# â†“â†“â†“ æ–°å¢æ™ºèƒ½ä¾§è¾¹æ ç»“æ„ â†“â†“â†“ #}
    <div id="ai-sidebar">
        <div class="ai-content">
            <h5 class="mb-3"><i class="fas fa-robot text-primary"></i> æ–‡ç« æ™ºèƒ½åŠ©æ‰‹</h5>

            {# ä¸Šä¸‹æ–‡æ„ŸçŸ¥å»ºè®® #}
            <div class="context-aware" onclick="askAboutTags()">
                <small class="text-muted">å½“å‰é¡µé¢åˆ†æï¼š</small>
                <div>ğŸ“Œ çƒ­é—¨æ ‡ç­¾ï¼š{{ hot_tags|join:", "|default:"æš‚æ— " }}</div>
            </div>

            {# èŠå¤©ç•Œé¢ #}
            <div id="ai-chat" class="mt-3"></div>
            <div class="input-group">
                <input type="text" id="ai-input" class="form-control"
                       placeholder="è¾“å…¥é—®é¢˜ï¼ˆå°è¯• @æ–‡ç«  æˆ– @æ ‡ç­¾ï¼‰...">
                <button class="btn btn-primary" onclick="sendAIRequest()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    {# ä¾§è¾¹æ è§¦å‘æŒ‰é’® #}
    <div id="ai-trigger" onclick="toggleSidebar()">
        <i class="fas fa-comment-dots mr-2"></i>æ™ºèƒ½åŠ©æ‰‹
    </div>
{% endblock content %}

{% block extra_css %}
    <style>
        /* å¡ç‰‡æ‚¬åœæ•ˆæœ */
        .card:hover {
            transform: translateY(-3px);
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        /* ç¼–è¾‘æŒ‰é’®åŠ¨ç”» */
        .btn-outline-primary:hover {
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        /* ä½œè€…æ ‡ç­¾æ ·å¼ */
        small.text-muted {
            font-size: 0.85rem;
        }

        {# â†“â†“â†“ æ–°å¢æ™ºèƒ½åŠ©æ‰‹æ ·å¼ â†“â†“â†“ #}
        /* æ™ºèƒ½åŠ©æ‰‹å®¹å™¨ */
        #ai-sidebar {
            position: fixed;
            right: -400px;
            top: 50%;
            transform: translateY(-50%);
            width: 380px;
            height: 70vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(5px);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.1);
            border-radius: 15px 0 0 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* è§¦å‘æŒ‰é’® */
        #ai-trigger {
            position: fixed;
            right: 0;
            top: 40%;
            background: linear-gradient(135deg, #4f46e5, #818cf8);
            color: white;
            padding: 1rem 0.5rem;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            writing-mode: vertical-rl;
            transform: translateY(-50%);
            box-shadow: -3px 3px 15px rgba(79, 70, 229, 0.2);
            transition: all 0.3s ease;
            z-index: 999;
        }

        /* å†…å®¹åŒºåŸŸ */
        .ai-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* ä¸Šä¸‹æ–‡æ„ŸçŸ¥æç¤º */
        .context-aware {
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
    </style>

    {% block extra_js %}
        <script>
            // â†“â†“â†“ æ–°å¢æ™ºèƒ½åŠ©æ‰‹é€»è¾‘ â†“â†“â†“
            let isSidebarOpen = false;

            // ä¾§è¾¹æ åˆ‡æ¢
            function toggleSidebar() {
                const sidebar = document.getElementById('ai-sidebar');
                sidebar.style.right = isSidebarOpen ? '-400px' : '0';
                isSidebarOpen = !isSidebarOpen;
            }

            // æ ‡ç­¾å»ºè®®å¿«æ·è¾“å…¥
            function askAboutTags() {
                const prompt = `å½“å‰é¡µé¢æ ‡ç­¾ï¼š{{ tags|join:", "|default:"æš‚æ— " }}ã€‚è¯·æ¨èç›¸å…³æŠ€æœ¯è¯é¢˜ï¼š`;
                document.getElementById('ai-input').value = prompt;
            }

            // å‘é€è¯·æ±‚
            function sendAIRequest() {
                const input = document.getElementById('ai-input').value;
                const chatBox = document.getElementById('ai-chat');

                // æ¸…ç©ºæ—§å†…å®¹
                chatBox.innerHTML = '<div class="loading-state">\n  <div class="loading-spinner"></div>\n  æ€è€ƒä¸­...\n</div>';

                fetch('', {  // ä¿æŒå½“å‰URLä¸å˜
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: input,
                        context: {
                            search: '{{ search|default:"" }}',
                            tag: '{{ tag|default:"" }}',
                            hot_tags: {{ hot_tags|safe }}
                        }
                    })
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`HTTPé”™è¯¯ ${response.status}`);
                        return response.json();
                    })
                    .then(data => {
                        chatBox.innerHTML = data.response
                            ? `<div class="ai-response">${data.response.replace(/\n/g, '<br>')}</div>`
                            : `<div class="alert alert-danger">é”™è¯¯ï¼š${data.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    })
                    .catch(error => {
                        chatBox.innerHTML = `<div class="alert alert-danger">è¯·æ±‚å¤±è´¥ï¼š${error.message}</div>`;
                    });
            }

            // ä¸ºæ¯ç¯‡æ–‡ç« æ·»åŠ å¿«é€Ÿæé—®æŒ‰é’®
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('.card').forEach(card => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-light position-absolute';
                    btn.style = 'bottom: 15px; right: 15px; padding: 0.25rem 0.5rem;';
                    btn.innerHTML = '<i class="fas fa-question-circle"></i> å¿«æ·æé—®';
                    btn.onclick = () => {
                        const title = card.querySelector('.card-title').innerText;
                        document.getElementById('ai-input').value = `@æ–‡ç«  è¯·è§£é‡Šï¼š${title}`;
                        if (!isSidebarOpen) toggleSidebar();
                    }
                    card.appendChild(btn);
                });
            });

            // æ ¼å¼ä¼˜åŒ–å‡½æ•°
            function formatResponse(text) {
                // ä»£ç å—é«˜äº®
                text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre class="p-2 bg-dark text-white rounded mb-2"><code>${code}</code></pre>`;
                });

                // åˆ—è¡¨æ ¼å¼åŒ–
                text = text.replace(/\n\s*â€¢\s+/g, '\nâ€¢ ');

                return text.replace(/\n/g, '<br>');
            }
        </script>
    {% endblock extra_js %}
{% endblock %}